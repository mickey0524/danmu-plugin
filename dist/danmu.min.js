(function(window){window.Danmu=function(className,options){this._init(className,options);this._requestTrack()};Danmu.prototype._init=function(className,options){var danmuEl=document.getElementsByClassName(className)[0];if(!checkIfCorrect(danmuEl)){throw new Error("The DOM node of danmu plugin is in wrong position!")}var videoContainer=danmuEl.parentNode;videoContainer.style.overflow="hidden";var parentPostiton=window.getComputedStyle(videoContainer).position;if(parentPostiton=="static"){videoContainer.style.position="relative"}var videoWidth=videoContainer.offsetWidth,videoHeight=videoContainer.offsetHeight;var trackHeight=(options&&options.Height)||24;var reminder=videoHeight%trackHeight;var trackNum=Math.floor(videoHeight/trackHeight);this.trackHeight=trackHeight;this.videoWidth=videoWidth;this.trackList=[];this.danmuList=[];this.el=danmuEl;this.faskDanmu=(options&&options.faskDanmu)||false;this.faskDanmuSpace=(options&&options.faskDanmu)||0;for(var i=0;i<trackNum;i++){if(i===trackNum-1){this.trackList.push(new Track(trackHeight+reminder))}else{this.trackList.push(new Track(trackHeight))}}};Danmu.prototype.updateDanmuList=function(danmuList){if(Object.prototype.toString.call(danmuList)!=="[object Array]"){throw new Error("The danmu data format is wrong!")}danmuList.forEach(function(danmuItem){danmuItem.isScroll=false;if(!danmuItem.speed){danmuItem.speed=getRandomSpeed(this.videoWidth)}if(!danmuItem.size){danmuItem.size=Math.floor(Math.random()*24)+18}}.bind(this));this.danmuList=this.danmuList.concat(danmuList)};Danmu.prototype.openFaskDanmu=function(faskDanmu,faskDanmuSpace){this.faskDanmu=faskDanmu;if(faskDanmuSpace){this.faskDanmuSpace=faskDanmuSpace}};Danmu.prototype._requestTrack=function(){this.reqTrackTimer=setInterval(function(){for(var i=0;i<this.danmuList.length;i++){if(this.danmuList[i].isScroll){continue}for(var j=0;j<this.trackList.length;j++){if(this.trackList[j].isExistWaitDanmu||(this.trackList[j].thresholdV<this.danmuList[i].speed&&(!this.faskDanmu||!compareSpeed(this.trackList[j],this.danmuList[i],this.videoWidth)))){continue}if(this.danmuList[i].size>this.trackList[j].trackHeight){if(j==this.trackList.length-1){continue}else{var danmuSize=this.danmuList[i].size;var curTrackHeight=this.trackList[j].trackHeight;var curIndex=j+1;var trackfound=false;while(curIndex<this.trackList.length){if(this.trackList[curIndex].isExistWaitDanmu||(this.trackList[curIndex].thresholdV<this.danmuList[i].speed&&(!this.faskDanmu||!compareSpeed(this.trackList[curIndex],this.danmuList[i],this.videoWidth)))){j=curIndex;break}curTrackHeight+=this.trackList[curIndex].trackHeight;if(curTrackHeight>danmuSize){for(var beginIndex=j;beginIndex<=curIndex;beginIndex++){this.trackList[beginIndex].isExistWaitDanmu=true;this.trackList[beginIndex].thresholdV=this.danmuList[i].speed;this.trackList[beginIndex].danmuNum+=1}this.danmuList[i].isScroll=true;this._danmuInsert(i,j,curIndex);i-=1;trackfound=true;break}curIndex+=1}if(trackfound){break}}}else{this.trackList[j].isExistWaitDanmu=true;this.trackList[j].thresholdV=this.danmuList[i].speed;this.trackList[j].danmuNum+=1;this.danmuList[i].isScroll=true;this._danmuInsert(i,j,j);i-=1;break}}}}.bind(this),200)};Danmu.prototype._danmuInsert=function(danmuIndex,beginIndex,endIndex){var danmuSize=this.danmuList[danmuIndex].size;var danmuColor=this.danmuList[danmuIndex].color||getRandomColor();var danmuContent=this.danmuList[danmuIndex].content||"弹幕啊";var HeightSum=0;for(var i=beginIndex;i<=endIndex;i++){HeightSum+=this.trackList[i].trackHeight}var offsetTop=beginIndex*this.trackHeight+(HeightSum-danmuSize)/2;var offsetLeft=this.videoWidth;var danmuNode=document.createElement("span");danmuNode.className="danmu-node";danmuNode.innerHTML=danmuContent;danmuNode.style.cssText="position: absolute; display: inline-block; color: "+danmuColor+"; font-size: "+(danmuSize)+"px; line-height: "+danmuSize+"px; top: "+offsetTop+"px; transform: translateX("+offsetLeft+"px);";this.el.appendChild(danmuNode);for(var i=beginIndex;i<=endIndex;i++){this.trackList[i].lastScrollDanmu=danmuNode}this._danmuAnimate(danmuIndex,danmuNode,beginIndex,endIndex)};Danmu.prototype._danmuAnimate=function(danmuIndex,danmuNode,beginIndex,endIndex){var danmuWidth=danmuNode.offsetWidth;var danmuSpeed=this.danmuList[danmuIndex].speed;var frameDistance=danmuSpeed/60;var changeNoWait=true;var _this=this;this.danmuList.splice(danmuIndex,1);function step(){var curOffset=danmuNode.style.transform.replace(/[^0-9|\-|\.]/g,"");var newOffset=curOffset-frameDistance;danmuNode.style.transform="translateX("+newOffset+"px)";if(newOffset>-danmuWidth){if(changeNoWait&&(newOffset<_this.videoWidth-danmuWidth)){for(var i=beginIndex;i<=endIndex;i++){_this.trackList[i].isExistWaitDanmu=false}changeNoWait=false}requestAnimationFrame(step)}else{danmuNode.parentNode.removeChild(danmuNode);for(var i=beginIndex;i<=endIndex;i++){_this.trackList[i].danmuNum-=1;if(_this.trackList[i].danmuNum===0){_this.trackList[i].thresholdV=Number.MAX_SAFE_INTEGER}}}}requestAnimationFrame(step)};function compareSpeed(track,danmu,videoWidth){if(!track.lastScrollDanmu){return true}var targetNode=track.lastScrollDanmu;var targetOffset=targetNode.style.transform.replace(/[^0-9|\-|\.]/g,"");var targetTime=(Number(targetNode.offsetWidth)+Number(targetOffset))/track.thresholdV;var chaserTime=(videoWidth-this.faskDanmuSpace)/danmu.speed;if(chaserTime>=targetTime){return true}return false}function Track(trackHeight){this.trackHeight=trackHeight;this.thresholdV=Number.MAX_SAFE_INTEGER;this.isExistWaitDanmu=false;this.danmuNum=0;this.lastScrollDanmu=null}function checkIfCorrect(danmuEl){var parentNode=danmuEl.parentNode;var video=parentNode.getElementsByTagName("video");if(video.length===0){return false}return true}function getRandomColor(){var redRatio=Math.floor(Math.random()*256),greenRatio=Math.floor(Math.random()*256),blueRatio=Math.floor(Math.random()*256);return"rgb("+redRatio+", "+greenRatio+", "+blueRatio+")"}function getRandomSpeed(videoWidth){var MIN_SPEED=videoWidth/10;var speed=Math.ceil(Math.random()*videoWidth/2);return Math.max(speed,MIN_SPEED)}})(window);