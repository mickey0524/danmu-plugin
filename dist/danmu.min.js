(function(window){var SUPER_DANMU_TIME="5000";window.Danmu=function(className,options){this._init(className,options)};Danmu.prototype._init=function(className,options){options=options||{};var danmuEl=document.getElementsByClassName(className)[0];if(!checkIfCorrect(danmuEl,this)){throw new Error("The DOM node of danmu plugin is in wrong position!")}var videoContainer=danmuEl.parentNode;videoContainer.style.overflow="hidden";var parentPostiton=window.getComputedStyle(videoContainer).position;if(parentPostiton=="static"){videoContainer.style.position="relative"}var videoWidth=videoContainer.offsetWidth,videoHeight=videoContainer.offsetHeight;var trackHeight=options.height||24;var reminder=videoHeight%trackHeight;var trackNum=Math.floor(videoHeight/trackHeight);this.trackHeight=trackHeight;this.videoWidth=videoWidth;this.trackList=[];this.danmuList=[];this.el=danmuEl;this.faskDanmu=options.faskDanmu||false;this.faskDanmuSpace=options.faskDanmuSpace||0;this.isPlay=true;if(options.variety&&options.variety=="video"){this.variety="video";this.curVideoTime=0}else{this.variety="live";this.clearScreen=options.clearScreen||false}for(var i=0;i<trackNum;i++){if(i===trackNum-1){this.trackList.push(new Track(trackHeight+reminder))}else{this.trackList.push(new Track(trackHeight))}}if(this.variety=="video"){this.videoTag.addEventListener("seeked",simpleThrottle(this._updateVideoTime.bind(this),200),false)}this.reqTrackTimer=setInterval(this._requestTrack.bind(this),200)};Danmu.prototype.updateDanmuList=function(danmuList){if(!this.isPlay){return}if(Object.prototype.toString.call(danmuList)!=="[object Array]"){throw new Error("The danmu data format is wrong!")}danmuList.forEach(function(danmuItem){danmuItem.isScroll=false;if(!danmuItem.speed){danmuItem.speed=getRandomSpeed(this.videoWidth)}if(!danmuItem.size){danmuItem.size=Math.floor(Math.random()*24)+18}if(!danmuItem.color){danmuItem.color=getRandomColor()}if(!danmuItem.content){danmuItem.content="弹幕呀"}if(!danmuItem.opacity){danmuItem.opacity=1}if(this.variety=="video"){danmuItem.timeStamp=danmuItem.timeStamp?Math.ceil(danmuItem.timeStamp):0}}.bind(this));if(this.variety=="video"){danmuList.sort(function(a,b){return a.timeStamp>b.timeStamp})}this.danmuList=this.danmuList.concat(danmuList)};Danmu.prototype.openFaskDanmu=function(faskDanmu,faskDanmuSpace){this.faskDanmu=faskDanmu;if(faskDanmuSpace){this.faskDanmuSpace=faskDanmuSpace}};Danmu.prototype.toggleDanmu=function(){if(this.isPlay){this._recoverDanmu();this.isPlay=false;clearInterval(this.reqTrackTimer)}else{this.reqTrackTimer=setInterval(this._requestTrack.bind(this),200);this.isPlay=true;if(this.variety=="live"&&!this.clearScreen){this.el.style.display="block"}}};Danmu.prototype.openDanmu=function(){if(this.isPlay){return}this.isPlay=true;this.reqTrackTimer=setInterval(this._requestTrack.bind(this),200);if(this.variety=="live"&&!this.clearScreen){this.el.style.display="block"}};Danmu.prototype.closeDanmu=function(){if(!this.isPlay){return}this._recoverDanmu();this.isPlay=false;clearInterval(this.reqTrackTimer)};Danmu.prototype.updateVideoTime=function(){if(this.variety=="video"){this.curVideoTime=Math.ceil(this.videoTag.currentTime);this._recoverDanmu();this.danmuList.forEach(function(danmu){if(danmu.timeStamp>=this.curVideoTime){danmu.isScroll=false}}.bind(this))}};Danmu.prototype._requestTrack=function(){if(this.variety=="video"){this.curVideoTime=Math.ceil(this.videoTag.currentTime)}for(var i=0;i<this.danmuList.length;i++){if(this.danmuList[i].isScroll){continue}if(this.variety=="video"&&this.danmuList[i].timeStamp>this.curVideoTime){continue}for(var j=0;j<this.trackList.length;j++){if(this.danmuList[i].isSuperDanmu&&this.trackList[j].isExistSuperDanmu){continue}if(!this.danmuList[i].isSuperDanmu&&(this.trackList[j].isExistWaitDanmu||(this.trackList[j].thresholdV<this.danmuList[i].speed&&(!this.faskDanmu||!compareSpeed(this.trackList[j],this.danmuList[i],this.videoWidth))))){continue}if(this.danmuList[i].size>this.trackList[j].trackHeight){if(j==this.trackList.length-1){continue}else{var danmuSize=this.danmuList[i].size;var curTrackHeight=this.trackList[j].trackHeight;var curIndex=j+1;var trackfound=false;while(curIndex<this.trackList.length){if(this.danmuList[i].isSuperDanmu&&this.trackList[curIndex].isExistSuperDanmu){j=curIndex;break}if(!this.danmuList[i].isSuperDanmu&&(this.trackList[curIndex].isExistWaitDanmu||(this.trackList[curIndex].thresholdV<this.danmuList[i].speed&&(!this.faskDanmu||!compareSpeed(this.trackList[curIndex],this.danmuList[i],this.videoWidth))))){j=curIndex;break}curTrackHeight+=this.trackList[curIndex].trackHeight;if(curTrackHeight>danmuSize){for(var beginIndex=j;beginIndex<=curIndex;beginIndex++){if(this.danmuList[i].isSuperDanmu){this.trackList[beginIndex].isExistSuperDanmu=true}else{this.trackList[beginIndex].isExistWaitDanmu=true;this.trackList[beginIndex].thresholdV=this.danmuList[i].speed;this.trackList[beginIndex].danmuNum+=1}}this.danmuList[i].isScroll=true;this._danmuInsert(i,j,curIndex);
if(this.variety=="live"){i-=1}trackfound=true;break}curIndex+=1}if(trackfound){break}}}else{this.danmuList[i].isScroll=true;if(this.danmuList[i].isSuperDanmu){this.trackList[j].isExistSuperDanmu=true}else{this.trackList[j].isExistWaitDanmu=true;this.trackList[j].thresholdV=this.danmuList[i].speed;this.trackList[j].danmuNum+=1;this._danmuInsert(i,j,j);if(this.variety=="live"){i-=1}}break}}}};Danmu.prototype._danmuInsert=function(danmuIndex,beginIndex,endIndex){var danmuSize=this.danmuList[danmuIndex].size;var danmuColor=this.danmuList[danmuIndex].color;var danmuContent=this.danmuList[danmuIndex].content;var isSuperDanmu=this.danmuList[danmuIndex].isSuperDanmu;var danmuOpacity=this.danmuList[danmuIndex].opacity;var HeightSum=0;for(var i=beginIndex;i<=endIndex;i++){HeightSum+=this.trackList[i].trackHeight}var offsetTop=beginIndex*this.trackHeight+(HeightSum-danmuSize)/2;var offsetLeft=this.videoWidth;var danmuNode=document.createElement("span");danmuNode.className="danmu-node";danmuNode.innerHTML=danmuContent;var cssText="position: absolute; display: inline-block; color: "+danmuColor+"; font-size: "+(danmuSize)+"px; line-height: "+danmuSize+"px"+"; top: "+offsetTop+"px; opacity: "+danmuOpacity+";";if(isSuperDanmu){danmuNode.style.cssText=cssText+" left: 50%; z-index: 100; transform: translateX(-50%);"}else{danmuNode.style.cssText=cssText+" transform: translateX("+offsetLeft+"px);";for(var i=beginIndex;i<=endIndex;i++){this.trackList[i].lastScrollDanmu=danmuNode}}this.el.appendChild(danmuNode);this._danmuAnimate(danmuIndex,danmuNode,beginIndex,endIndex)};Danmu.prototype._danmuAnimate=function(danmuIndex,danmuNode,beginIndex,endIndex){if(this.danmuList[danmuIndex].isSuperDanmu){setTimeout(function(){danmuNode.parentNode.removeChild(danmuNode);for(var i=beginIndex;i<=endIndex;i++){this.trackList[i].isExistSuperDanmu=false}}.bind(this),SUPER_DANMU_TIME)}else{var danmuWidth=danmuNode.offsetWidth;var danmuSpeed=this.danmuList[danmuIndex].speed;var frameDistance=danmuSpeed/60;var changeNoWait=true;if(this.variety=="live"){this.danmuList.splice(danmuIndex,1)}var _this=this;function step(){if(!danmuNode.parentNode){return}var curOffset=danmuNode.style.transform.replace(/[^0-9|\-|\.]/g,"");var newOffset=curOffset-frameDistance;danmuNode.style.transform="translateX("+newOffset+"px)";if(newOffset>-danmuWidth){if(changeNoWait&&(newOffset<_this.videoWidth-danmuWidth)){for(var i=beginIndex;i<=endIndex;i++){_this.trackList[i].isExistWaitDanmu=false}changeNoWait=false}requestAnimationFrame(step)}else{danmuNode.parentNode.removeChild(danmuNode);for(var i=beginIndex;i<=endIndex;i++){_this.trackList[i].danmuNum-=1;if(_this.trackList[i].danmuNum===0){_this.trackList[i].thresholdV=Number.MAX_SAFE_INTEGER}}}}requestAnimationFrame(step)}};Danmu.prototype._recoverDanmu=function(){var _this=this;function recoverTrack(){_this.trackList.forEach(function(track){track.thresholdV=Number.MAX_SAFE_INTEGER;track.isExistWaitDanmu=false;track.danmuNum=0;track.lastScrollDanmu=null})}if(this.variety=="video"){this.el.innerHTML="";this.danmuList=[];recoverTrack()}else{if(this.clearScreen){this.el.innerHTML="";recoverTrack()}else{this.el.style.display="none"}}};function simpleThrottle(fn,delay){var startTime=new Date();var timer=null;return function(){if(new Date()-startTime>=delay){clearTimeout(timer);fn();startTime=new Date()}else{timer=setTimeout(fn,delay)}}}function compareSpeed(track,danmu,videoWidth){if(!track.lastScrollDanmu){return true}var targetNode=track.lastScrollDanmu;var targetOffset=targetNode.style.transform.replace(/[^0-9|\-|\.]/g,"");var targetTime=(Number(targetNode.offsetWidth)+Number(targetOffset))/track.thresholdV;var chaserTime=(videoWidth-this.faskDanmuSpace)/danmu.speed;if(chaserTime>=targetTime){return true}return false}function Track(trackHeight){this.isExistSuperDanmu=false;this.trackHeight=trackHeight;this.thresholdV=Number.MAX_SAFE_INTEGER;this.isExistWaitDanmu=false;this.danmuNum=0;this.lastScrollDanmu=null}function checkIfCorrect(danmuEl,that){var parentNode=danmuEl.parentNode;var video=parentNode.getElementsByTagName("video");if(video.length===0){return false}that.videoTag=video[0];return true}function getRandomColor(){var redRatio=Math.floor(Math.random()*256),greenRatio=Math.floor(Math.random()*256),blueRatio=Math.floor(Math.random()*256);return"rgb("+redRatio+", "+greenRatio+", "+blueRatio+")"}function getRandomSpeed(videoWidth){var MIN_SPEED=videoWidth/10;var speed=Math.ceil(Math.random()*videoWidth/2);return Math.max(speed,MIN_SPEED)}})(window);